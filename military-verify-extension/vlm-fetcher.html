<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VLM Veteran Fetcher</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            color: #fff;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
        }

        h1 {
            text-align: center;
            margin-bottom: 20px;
            background: linear-gradient(90deg, #00d9ff, #00ff88);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .controls {
            background: rgba(255, 255, 255, 0.05);
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .row {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-bottom: 15px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            color: #888;
            font-size: 0.85rem;
        }

        input,
        select {
            padding: 10px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 6px;
            background: rgba(255, 255, 255, 0.05);
            color: #fff;
            font-size: 14px;
        }

        input:focus,
        select:focus {
            outline: none;
            border-color: #00d9ff;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 6px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-primary {
            background: linear-gradient(135deg, #00d9ff, #00ff88);
            color: #000;
        }

        .btn-secondary {
            background: rgba(255, 255, 255, 0.1);
            color: #fff;
        }

        .btn-danger {
            background: rgba(255, 77, 77, 0.3);
            color: #ff4d4d;
        }

        .btn:hover {
            transform: translateY(-2px);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        #progress {
            background: rgba(0, 217, 255, 0.1);
            border: 1px solid rgba(0, 217, 255, 0.2);
            border-radius: 6px;
            padding: 15px;
            margin-bottom: 20px;
            display: none;
        }

        .progress-bar {
            height: 8px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
            overflow: hidden;
            margin: 10px 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #00d9ff, #00ff88);
            width: 0%;
            transition: width 0.3s;
        }

        #output {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
            padding: 15px;
        }

        #result {
            width: 100%;
            height: 400px;
            background: rgba(0, 0, 0, 0.5);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 6px;
            color: #0f0;
            font-family: 'Consolas', monospace;
            font-size: 12px;
            padding: 10px;
            resize: vertical;
        }

        .stats {
            display: flex;
            gap: 20px;
            margin-bottom: 10px;
        }

        .stat {
            padding: 10px 20px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 6px;
        }

        .stat-value {
            font-size: 1.5rem;
            font-weight: bold;
            color: #00d9ff;
        }

        .stat-label {
            font-size: 0.8rem;
            color: #666;
        }
    </style>
</head>

<body>
    <div class="container">
        <h1>üéñÔ∏è VLM Veteran Fetcher</h1>

        <div class="controls">
            <div class="row">
                <div>
                    <label>Start Letter</label>
                    <select id="startLetter"></select>
                </div>
                <div>
                    <label>End Letter</label>
                    <select id="endLetter"></select>
                </div>
                <div>
                    <label>Branch</label>
                    <select id="branch">
                        <option value="">All Branches</option>
                        <option value="N">Navy</option>
                        <option value="A">Army</option>
                        <option value="F">Air Force</option>
                        <option value="M">Marine Corps</option>
                        <option value="C">Coast Guard</option>
                    </select>
                </div>
                <div>
                    <label>Year</label>
                    <input type="number" id="year" value="2025" min="2000" max="2030">
                </div>
                <div>
                    <label>Records/Page</label>
                    <input type="number" id="limit" value="100" min="25" max="500">
                </div>
            </div>
            <div class="row">
                <button class="btn btn-primary" id="fetchBtn">üöÄ Start Fetching</button>
                <button class="btn btn-secondary" id="copyBtn" disabled>üìã Copy All</button>
                <button class="btn btn-secondary" id="downloadBtn" disabled>üíæ Download TXT</button>
                <button class="btn btn-danger" id="stopBtn" disabled>‚èπÔ∏è Stop</button>
            </div>
        </div>

        <div id="progress">
            <div>Fetching: <span id="currentLetter">-</span> | Page: <span id="currentPage">-</span></div>
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill"></div>
            </div>
            <div id="progressText">0%</div>
        </div>

        <div class="stats">
            <div class="stat">
                <div class="stat-value" id="totalCount">0</div>
                <div class="stat-label">Total Veterans</div>
            </div>
            <div class="stat">
                <div class="stat-value" id="letterCount">0</div>
                <div class="stat-label">Letters Done</div>
            </div>
        </div>

        <div id="output">
            <textarea id="result" readonly placeholder="Results will appear here..."></textarea>
        </div>
    </div>

    <script>
        // Populate letter dropdowns
        const letters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ'.split('');
        const startSelect = document.getElementById('startLetter');
        const endSelect = document.getElementById('endLetter');
        letters.forEach(l => {
            startSelect.add(new Option(l, l.toLowerCase()));
            endSelect.add(new Option(l, l.toLowerCase()));
        });
        endSelect.value = 'z';

        const MONTHS = ['January', 'February', 'March', 'April', 'May', 'June',
            'July', 'August', 'September', 'October', 'November', 'December'];

        let isRunning = false;
        let allVeterans = [];

        function parseDate(dateStr) {
            if (!dateStr) return { month: 'January', day: '1', year: '2025' };
            const date = new Date(dateStr);
            return {
                month: MONTHS[date.getMonth()] || 'January',
                day: date.getDate().toString(),
                year: date.getFullYear().toString()
            };
        }

        function parseBranch(code) {
            const map = { 'A': 'Army', 'F': 'Air Force', 'N': 'Navy', 'M': 'Marine Corps', 'C': 'Coast Guard', 'S': 'Space Force' };
            return map[code] || code || 'Navy';
        }

        async function fetchPage(lastName, page, branch, year, limit) {
            const payload = {
                lastName: lastName,
                dodFrom: `${year}-01-01`,
                dodTo: `${year}-12-31`,
                orderby: 'date_of_death',
                limit: limit,
                page: page
            };
            if (branch) payload.branchCode = branch;

            const response = await fetch('https://www.vlm.cem.va.gov/api/v1.1/gcio/profile/search/advanced', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            return response.json();
        }

        function formatVeteran(v) {
            return `${v.firstName}|${v.lastName}|${v.branch}|${v.birthMonth}|${v.birthDay}|${v.birthYear}|${v.deathMonth}|${v.deathDay}|${v.deathYear}`;
        }

        async function startFetching() {
            const startIdx = letters.indexOf(startSelect.value.toUpperCase());
            const endIdx = letters.indexOf(endSelect.value.toUpperCase());
            const branch = document.getElementById('branch').value;
            const year = document.getElementById('year').value;
            const limit = parseInt(document.getElementById('limit').value);

            if (startIdx > endIdx) {
                alert('Start letter must be before end letter');
                return;
            }

            isRunning = true;
            allVeterans = [];
            document.getElementById('fetchBtn').disabled = true;
            document.getElementById('stopBtn').disabled = false;
            document.getElementById('progress').style.display = 'block';
            document.getElementById('result').value = '';

            const targetLetters = letters.slice(startIdx, endIdx + 1);
            let lettersDone = 0;

            for (const letter of targetLetters) {
                if (!isRunning) break;

                document.getElementById('currentLetter').textContent = letter;
                let page = 1;
                let hasMore = true;

                while (hasMore && isRunning) {
                    document.getElementById('currentPage').textContent = page;

                    try {
                        const data = await fetchPage(letter.toLowerCase(), page, branch, year, limit);

                        if (data.profiles && data.profiles.length > 0) {
                            for (const p of data.profiles) {
                                const dob = parseDate(p.dob);
                                const dod = parseDate(p.dod);
                                const nameParts = (p.full_name || '').trim().split(' ');

                                allVeterans.push({
                                    firstName: nameParts[0] || '',
                                    lastName: nameParts.slice(1).join(' ') || '',
                                    branch: parseBranch(p.branch_code),
                                    birthMonth: dob.month, birthDay: dob.day, birthYear: dob.year,
                                    deathMonth: dod.month, deathDay: dod.day, deathYear: dod.year
                                });
                            }

                            hasMore = data.profiles.length >= limit;
                            page++;
                            await new Promise(r => setTimeout(r, 150));
                        } else {
                            hasMore = false;
                        }
                    } catch (e) {
                        console.error(e);
                        hasMore = false;
                    }
                }

                lettersDone++;
                const progress = (lettersDone / targetLetters.length) * 100;
                document.getElementById('progressFill').style.width = progress + '%';
                document.getElementById('progressText').textContent = Math.round(progress) + '%';
                document.getElementById('letterCount').textContent = lettersDone;
                document.getElementById('totalCount').textContent = allVeterans.length;

                // Update result
                document.getElementById('result').value = allVeterans.map(formatVeteran).join('\n');

                await new Promise(r => setTimeout(r, 300));
            }

            isRunning = false;
            document.getElementById('fetchBtn').disabled = false;
            document.getElementById('stopBtn').disabled = true;
            document.getElementById('copyBtn').disabled = false;
            document.getElementById('downloadBtn').disabled = false;
        }

        document.getElementById('fetchBtn').addEventListener('click', startFetching);

        document.getElementById('stopBtn').addEventListener('click', () => {
            isRunning = false;
        });

        document.getElementById('copyBtn').addEventListener('click', () => {
            navigator.clipboard.writeText(document.getElementById('result').value);
            alert('Copied ' + allVeterans.length + ' records!');
        });

        document.getElementById('downloadBtn').addEventListener('click', () => {
            const blob = new Blob([document.getElementById('result').value], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `veterans_${document.getElementById('year').value}.txt`;
            a.click();
            URL.revokeObjectURL(url);
        });
    </script>
</body>

</html>